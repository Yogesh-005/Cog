<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Robot Self-Awareness Demo</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cytoscape/3.23.0/cytoscape.min.css">
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial; background:#0f1724; color:#e6eef8; height:100vh; }
        .container { display:flex; height:100vh; }
        .sidebar { width:280px; background:#0b1220; border-right:1px solid #10203a; padding:16px; display:flex; flex-direction:column; }
        .sidebar h2 { color:#7be0ff; margin-bottom:12px; }
        .new-story-btn { background:#7be0ff; color:#071022; border:none; padding:10px 12px; border-radius:8px; cursor:pointer; font-weight:600; margin-bottom:12px; }
        .sessions-list { flex:1; overflow:auto; }
        .session-item { background:#081323; padding:10px; margin-bottom:8px; border-radius:6px; cursor:pointer; display:flex; align-items:center; justify-content:space-between; }
        .session-item.active { background:#7be0ff; color:#071022; font-weight:700; }
        .session-left { display:flex; gap:8px; align-items:center; }
        .session-name { font-size:14px; }
        .session-controls { display:flex; gap:6px; align-items:center; }
        .icon-btn { background:transparent; border:none; color:#99bcd7; cursor:pointer; font-size:14px; padding:6px; border-radius:4px; }
        .icon-btn:hover { color:#ff7b7b; }
        .main { flex:1; display:flex; flex-direction:column; }
        .header { padding:16px; background:#071026; border-bottom:1px solid #0f2a44; display:flex; justify-content:space-between; align-items:center; }
        .title { color:#7be0ff; font-size:20px; }
        .tts-toggle { background:#071026; color:#7be0ff; border:1px solid #0f2a44; padding:8px 10px; border-radius:6px; cursor:pointer; }
        .tabs { display:flex; gap:8px; background:#071026; border-bottom:1px solid #0f2a44; padding:8px 12px; }
        .tab { padding:8px 12px; cursor:pointer; color:#9fbfdc; border-radius:6px; }
        .tab.active { color:#071022; background:#7be0ff; }
        .content { flex:1; display:flex; position:relative; }
        .view { position:absolute; inset:0; display:none; flex-direction:column; }
        .view.active { display:flex; }
        .chat { display:flex; flex-direction:column; height:100%; }
        .chat-messages { flex:1; overflow:auto; padding:16px; }
        .message { margin-bottom:14px; }
        .message.user .bubble { background:#052033; color:#dff4ff; border-radius:8px; padding:10px; max-width:75%; }
        .message.assistant .bubble { background:#0f2340; color:#e6f7ff; border-radius:8px; padding:12px; max-width:90%; }
        .message-label { font-size:12px; color:#99bcd7; margin-bottom:6px; }
        .input-area { padding:14px; border-top:1px solid #0f2a44; background:#071026; display:flex; gap:8px; }
        textarea.story-input { flex:1; min-height:60px; padding:10px; border:1px solid #12324a; border-radius:8px; background:#041220; color:#e6f7ff; resize:vertical; }
        .send-btn { background:#7be0ff; color:#071022; border:none; padding:10px 14px; border-radius:8px; cursor:pointer; font-weight:700; }
        .voice-btn { background:#072a3a; color:#9fd9ff; border:none; padding:10px 12px; border-radius:8px; cursor:pointer; }
        #graph-container { flex:1; background:#071026; }
        .empty-state { height:100%; display:flex; align-items:center; justify-content:center; color:#94b7d6; }
        .analyzing { color:#7be0ff; font-style:italic; padding:8px 16px; }
    </style>
</head>
<body>
    <div class="container">
        <div class="sidebar">
            <h2>Stories</h2>
            <button class="new-story-btn" onclick="createNewStory()">+ New Story</button>
            <div class="sessions-list" id="sessionsList"></div>
        </div>

        <div class="main">
            <div class="header">
                <div class="title">Robot Self-Awareness Demo</div>
                <div>
                    <button id="ttsToggle" class="tts-toggle" onclick="toggleTTS()">ðŸ”Š Voice: On</button>
                </div>
            </div>

            <div class="tabs" id="tabsBar">
                <div class="tab active" data-tab="chat" onclick="switchTab('chat', event)">Chat</div>
                <div class="tab" data-tab="graph" onclick="switchTab('graph', event)">Knowledge Graph</div>
            </div>

            <div class="content">
                <div class="view active" id="chatView">
                    <div class="chat" style="height:100%">
                        <div class="chat-messages" id="chatMessages">
                            <div class="empty-state">Click "New Story" to begin (the first message in a session should be the story to analyze).</div>
                        </div>

                        <div class="input-area" id="inputArea" style="display:none;">
                            <textarea id="storyInput" class="story-input" placeholder="Please enter the story (first message will be analyzed)."></textarea>
                            <button class="voice-btn" id="voiceBtn" onclick="toggleVoiceRecording()">ðŸŽ¤</button>
                            <button class="send-btn" onclick="sendStory()">Send</button>
                        </div>
                    </div>
                </div>

                <div class="view" id="graphView">
                    <div id="graph-container" class="empty-state">Graph is empty. Analyze a story first.</div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/cytoscape/3.23.0/cytoscape.min.js"></script>
    <script>
        const API_URL = 'http://localhost:5000';
        let sessions = [];
        let currentSessionId = null;
        let recognition = null;
        let cy = null;
        let ttsEnabled = true;

        // Setup Web Speech Recognition
        if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
            const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
            recognition = new SR();
            recognition.continuous = false;
            recognition.interimResults = false;
            recognition.onresult = (e) => {
                const transcript = e.results[0][0].transcript;
                document.getElementById('storyInput').value = transcript;
            };
            recognition.onend = () => {
                document.getElementById('voiceBtn').classList.remove('recording');
            };
        }

        function toggleTTS() {
            ttsEnabled = !ttsEnabled;
            document.getElementById('ttsToggle').textContent = ttsEnabled ? 'ðŸ”Š Voice: On' : 'ðŸ”‡ Voice: Off';
        }

        async function loadSessions() {
            try {
                const res = await fetch(`${API_URL}/sessions`);
                sessions = await res.json();
                renderSessionsList();
            } catch (e) {
                console.error('Error loading sessions', e);
            }
        }

        function renderSessionsList() {
            const list = document.getElementById('sessionsList');
            list.innerHTML = '';
            sessions.forEach((session, idx) => {
                const item = document.createElement('div');
                item.className = 'session-item' + (session.id === currentSessionId ? ' active' : '');
                item.onclick = () => loadSession(session.id);

                const left = document.createElement('div');
                left.className = 'session-left';
                const name = document.createElement('div');
                name.className = 'session-name';
                name.textContent = session.name || `Story ${idx+1}`;
                name.onclick = (ev) => { ev.stopPropagation(); renameSessionPrompt(session.id); };
                left.appendChild(name);

                const controls = document.createElement('div');
                controls.className = 'session-controls';

                const renameBtn = document.createElement('button');
                renameBtn.className = 'icon-btn';
                renameBtn.title = 'Rename';
                renameBtn.innerHTML = 'âœï¸';
                renameBtn.onclick = (ev) => { ev.stopPropagation(); renameSessionPrompt(session.id); };

                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'icon-btn';
                deleteBtn.title = 'Delete';
                deleteBtn.innerHTML = 'ðŸ—‘ï¸';
                deleteBtn.onclick = (ev) => { ev.stopPropagation(); deleteSession(session.id); };

                controls.appendChild(renameBtn);
                controls.appendChild(deleteBtn);

                item.appendChild(left);
                item.appendChild(controls);
                list.appendChild(item);
            });
        }

        async function createNewStory() {
            try {
                const res = await fetch(`${API_URL}/sessions`, { method: 'POST' });
                const session = await res.json();
                sessions.push(session);
                currentSessionId = session.id;
                renderSessionsList();
                document.getElementById('inputArea').style.display = 'flex';
                document.getElementById('chatMessages').innerHTML = '';
                appendSystemMessage('Please enter the story as the first message â€” the app will analyze it and build a knowledge graph.');
            } catch (e) {
                console.error('Error creating session', e);
            }
        }

        async function renameSessionPrompt(sessionId) {
            const newName = prompt('Enter a new name for this story:');
            if (!newName) return;
            try {
                const res = await fetch(`${API_URL}/sessions/${sessionId}`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ name: newName })
                });
                const result = await res.json();
                // refresh
                await loadSessions();
                if (currentSessionId === sessionId) loadSession(sessionId);
            } catch (e) {
                console.error('Rename failed', e);
            }
        }

        async function deleteSession(sessionId) {
            if (!confirm('Delete this story permanently?')) return;
            try {
                await fetch(`${API_URL}/sessions/${sessionId}`, { method: 'DELETE' });
                sessions = sessions.filter(s => s.id !== sessionId);
                if (currentSessionId === sessionId) {
                    currentSessionId = null;
                    document.getElementById('chatMessages').innerHTML = '<div class="empty-state">Click "New Story" to begin.</div>';
                    document.getElementById('inputArea').style.display = 'none';
                    document.getElementById('graph-container').innerHTML = 'Graph is empty. Analyze a story first.';
                }
                renderSessionsList();
            } catch (e) {
                console.error('Error deleting session', e);
            }
        }

        async function loadSession(sessionId) {
            try {
                const res = await fetch(`${API_URL}/sessions/${sessionId}`);
                const session = await res.json();
                currentSessionId = sessionId;
                renderSessionsList();
                renderChatMessages(session.messages || []);
                if (session.graph_data && session.graph_data.nodes && session.graph_data.nodes.length > 0) {
                    renderGraph(session.graph_data);
                } else {
                    document.getElementById('graph-container').innerHTML = 'Graph is empty. Analyze a story first.';
                }
                document.getElementById('inputArea').style.display = 'flex';
            } catch (e) {
                console.error('Error loading session', e);
            }
        }

        function renderChatMessages(messages) {
            const container = document.getElementById('chatMessages');
            container.innerHTML = '';
            if (!messages || messages.length === 0) {
                container.innerHTML = '<div class="empty-state">No messages. Enter the story to analyze.</div>';
                return;
            }
            messages.forEach(msg => {
                const m = document.createElement('div');
                m.className = 'message ' + (msg.role === 'user' ? 'user' : 'assistant');
                const label = document.createElement('div');
                label.className = 'message-label';
                label.textContent = msg.role === 'user' ? 'You' : 'AI';
                const bubble = document.createElement('div');
                bubble.className = 'bubble';
                bubble.innerHTML = msg.content;
                m.appendChild(label);
                m.appendChild(bubble);
                container.appendChild(m);
            });
            container.scrollTop = container.scrollHeight;
        }

        function appendSystemMessage(text) {
            const container = document.getElementById('chatMessages');
            const m = document.createElement('div');
            m.className = 'message assistant';
            const label = document.createElement('div');
            label.className = 'message-label';
            label.textContent = 'System';
            const bubble = document.createElement('div');
            bubble.className = 'bubble analyzing';
            bubble.textContent = text;
            m.appendChild(label);
            m.appendChild(bubble);
            container.appendChild(m);
            container.scrollTop = container.scrollHeight;
        }

        async function sendStory() {
            if (!currentSessionId) return;
            const inputEl = document.getElementById('storyInput');
            const text = inputEl.value.trim();
            if (!text) return;
            inputEl.value = '';

            // Append user's message
            const container = document.getElementById('chatMessages');
            const userMsg = document.createElement('div');
            userMsg.className = 'message user';
            const label = document.createElement('div'); label.className = 'message-label'; label.textContent = 'You';
            const bubble = document.createElement('div'); bubble.className = 'bubble'; bubble.textContent = text;
            userMsg.appendChild(label); userMsg.appendChild(bubble);
            container.appendChild(userMsg);
            container.scrollTop = container.scrollHeight;

            // Show analyzing
            const analyzing = document.createElement('div');
            analyzing.className = 'analyzing';
            analyzing.textContent = 'Processing...';
            container.appendChild(analyzing);
            container.scrollTop = container.scrollHeight;

            try {
                // check if analyzed already
                const session = sessions.find(s => s.id === currentSessionId) || (await (await fetch(`${API_URL}/sessions/${currentSessionId}`)).json());
                const analyzed = session?.metadata?.analyzed;

                let endpoint = `${API_URL}/sessions/${currentSessionId}/story`;
                let payload = { story: text };
                if (analyzed) {
                    endpoint = `${API_URL}/sessions/${currentSessionId}/question`;
                    payload = { question: text };
                }

                const res = await fetch(endpoint, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(payload)
                });

                const result = await res.json();
                analyzing.remove();

                if (result.error) {
                    appendSystemMessage(result.error || 'Error analyzing story. Try again.');
                    return;
                }

                // Append assistant response (HTML content)
                const assistantMsg = document.createElement('div');
                assistantMsg.className = 'message assistant';
                const aLabel = document.createElement('div'); aLabel.className = 'message-label'; aLabel.textContent = 'AI';
                const aBubble = document.createElement('div'); aBubble.className = 'bubble';
                aBubble.innerHTML = result.message || result;
                assistantMsg.appendChild(aLabel); assistantMsg.appendChild(aBubble);
                container.appendChild(assistantMsg);
                container.scrollTop = container.scrollHeight;

                // Text-to-speech of response (if enabled)
                if (ttsEnabled && window.speechSynthesis) {
                    try {
                        const utter = new SpeechSynthesisUtterance(stripHtml(result.message || ''));
                        window.speechSynthesis.cancel();
                        window.speechSynthesis.speak(utter);
                    } catch (e) {
                        console.warn('TTS failed', e);
                    }
                }

                // update local session list and refresh
                await loadSessions();
                await loadSession(currentSessionId);
            } catch (e) {
                console.error('Error sending story/question', e);
                document.querySelector('.analyzing').textContent = 'Error processing input. Please try again.';
            }
        }

        function stripHtml(html) {
            const tmp = document.createElement('div');
            tmp.innerHTML = html;
            return tmp.textContent || tmp.innerText || '';
        }

        // Voice recording toggle
        function toggleVoiceRecording() {
            if (!recognition) {
                alert('Voice recognition not supported in this browser. Use Chrome.');
                return;
            }
            const btn = document.getElementById('voiceBtn');
            if (btn.classList.contains('recording')) {
                recognition.stop();
                btn.classList.remove('recording');
            } else {
                recognition.start();
                btn.classList.add('recording');
            }
        }

        // Tab switching
        function switchTab(tab, ev) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            ev.target.classList.add('active');
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            document.getElementById(tab + 'View').classList.add('active');
            if (tab === 'graph') {
                if (cy) { cy.resize(); cy.fit(); }
            }
        }

        function renderGraph(graphData) {
            const container = document.getElementById('graph-container');
            container.innerHTML = '';
            if (!graphData || !graphData.nodes || graphData.nodes.length === 0) {
                container.innerHTML = 'Graph is empty. Analyze a story first.';
                return;
            }
            const elements = [
                ...graphData.nodes.map(n => ({ data: { id: n.id, label: n.label }, classes: n.from_story ? 'main' : 'related' })),
                ...graphData.edges.map((e, i) => ({ data: { id: 'e' + i, source: e.source, target: e.target, label: e.label } }))
            ];
            cy = cytoscape({
                container: container,
                elements: elements,
                style: [
                    { selector: 'node', style: { 'background-color': '#7be0ff', 'label': 'data(label)', 'text-valign': 'center', 'text-halign': 'center', 'width': '40px', 'height': '40px', 'font-size': '10px' } },
                    { selector: 'node.main', style: { 'background-color': '#ffd166', 'width': '60px', 'height': '60px' } },
                    { selector: 'edge', style: { 'width': 2, 'line-color': '#0f2a44', 'target-arrow-color': '#0f2a44', 'target-arrow-shape': 'triangle', 'curve-style': 'bezier', 'label': 'data(label)', 'font-size': '8px' } }
                ],
                layout: { name: 'cose', animate: true, nodeRepulsion: 8000, idealEdgeLength: 120 }
            });
        }

        // Init
        loadSessions();
    </script>
</body>
</html>
